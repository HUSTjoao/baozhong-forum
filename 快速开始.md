# 🚀 数据库迁移 - 快速开始

## ✅ 已完成的工作

我已经为您完成了从 localStorage 到 PostgreSQL 数据库的完整迁移准备工作：

### 1. 后端 API（全部完成）✓

- **问题管理**：创建、删除、点赞、查询
- **回复管理**：创建、删除、点赞（支持嵌套回复）
- **举报功能**：提交、查询、状态管理
- **学长学姐寄语**：创建、删除、点赞、查询

### 2. 数据库 Schema 更新 ✓

- 更新了 `prisma/schema.prisma`
- 添加了 `AlumniMessageLike` 表用于追踪寄语点赞

### 3. 前端代码重构 ✓

- 创建了 `lib/api-client.ts` 统一管理 API 调用
- 重写了论坛详情页面（`app/forum/[id]/page-new.tsx`）
- 重写了寄语页面（`app/messages/page-new.tsx`）

### 4. 数据迁移工具 ✓

- 创建了浏览器端迁移脚本（`scripts/migrate-from-localstorage.ts`）

---

## 📝 您需要执行的3个步骤

### 步骤1：更新数据库 Schema

在项目根目录打开命令行，执行：

```powershell
npx prisma generate
npx prisma db push
```

> 💡 如果提示需要确认，输入 `y` 并回车

### 步骤2：替换前端文件

**方法A：手动替换（推荐）**

在文件资源管理器中：
1. 找到 `app\forum\[id]\` 文件夹
   - 将 `page.tsx` 重命名为 `page.tsx.backup`（备份）
   - 将 `page-new.tsx` 重命名为 `page.tsx`

2. 找到 `app\messages\` 文件夹
   - 将 `page.tsx` 重命名为 `page.tsx.backup`（备份）
   - 将 `page-new.tsx` 重命名为 `page.tsx`

**方法B：使用命令行**

在 PowerShell 中（项目根目录）：

```powershell
# 备份并替换论坛详情页
Rename-Item "app\forum\[id]\page.tsx" "page.tsx.backup"
Rename-Item "app\forum\[id]\page-new.tsx" "page.tsx"

# 备份并替换寄语页面
Rename-Item "app\messages\page.tsx" "page.tsx.backup"
Rename-Item "app\messages\page-new.tsx" "page.tsx"
```

### 步骤3：重启开发服务器

```powershell
# 如果服务器正在运行，先按 Ctrl+C 停止
# 然后重新启动
npm run dev
```

---

## 🎯 测试迁移是否成功

打开浏览器访问 `http://localhost:3000`，测试以下功能：

1. ✅ 发布新问题
2. ✅ 发表回复
3. ✅ 点赞问题和回复
4. ✅ 删除自己的内容
5. ✅ 发布学长学姐寄语
6. ✅ 在不同浏览器登录同一账号，查看数据是否同步

---

## 📦 迁移现有数据（可选）

如果您的浏览器中有重要的旧数据需要迁移：

1. 确保已登录（需要管理员账号）
2. 按 F12 打开浏览器开发者工具
3. 切换到 "Console" 标签
4. 打开 `scripts/migrate-from-localstorage.ts` 文件
5. 复制全部内容到控制台并回车执行
6. 查看迁移统计信息

> ⚠️ **注意**：点赞记录无法自动迁移，需要用户重新点赞

---

## ❓ 遇到问题？

### 问题：命令行报错 "npx 不是内部或外部命令"

**解决**：确保已安装 Node.js，重新打开命令行窗口

### 问题：页面显示空白或报错

**解决**：
1. 检查浏览器控制台的错误信息
2. 确认数据库连接配置正确（检查 `.env` 文件）
3. 重新运行 `npm install` 安装依赖

### 问题：数据不显示

**解决**：
1. 检查是否已登录
2. 打开 Prisma Studio 查看数据库：`npx prisma studio`
3. 确认 API 是否正常响应（查看 Network 标签）

---

## 🎉 完成！

完成上述步骤后，您的论坛系统已经成功迁移到数据库！

**主要优势**：
- 🌐 数据在所有设备间自动同步
- 💾 数据永久保存，不受浏览器缓存影响
- 👥 支持真正的多用户协作
- 🔒 更安全的数据管理

**详细文档**：
- 完整迁移指南：`MIGRATION_GUIDE.md`
- 技术细节和故障排查请参考详细指南

---

需要更多帮助？欢迎随时询问！

